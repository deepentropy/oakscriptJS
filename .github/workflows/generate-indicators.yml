name: Generate Indicators

on:
  push:
    branches: [main]
    paths:
      # Trigger when PineScript source files change
      - 'pinescript/**/*.pine'
      # Or when transpiler changes
      - 'transpiler/**'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Need write access to commit generated files

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build transpiler
        run: pnpm --filter @deepentropy/oakscript-engine build
      
      - name: Generate indicators
        run: |
          # Find all .pine files and transpile them
          for pine_file in pinescript/*.pine; do
            if [ -f "$pine_file" ]; then
              # Extract base name and convert to kebab-case
              base_name=$(basename "$pine_file" .pine)
              # Replace spaces first, then convert camelCase to kebab-case
              indicator_name=$(echo "$base_name" | tr ' ' '-' | sed 's/\([a-z0-9]\)\([A-Z]\)/\1-\2/g' | tr '[:upper:]' '[:lower:]')
              output_dir="indicators/$indicator_name"
              output_file="$output_dir/$indicator_name.ts"
              
              echo "Transpiling $pine_file -> $output_file"
              
              # Create output directory if it doesn't exist
              mkdir -p "$output_dir"
              
              # Run the transpiler
              node ./transpiler/bin/pine2ts.js "$pine_file" "$output_file"
            fi
          done
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet indicators/ || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit generated indicators
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add indicators/
          git commit -m "chore: auto-generate indicators from PineScript sources"
          git push
