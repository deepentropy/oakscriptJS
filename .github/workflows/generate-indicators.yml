name: Generate Indicators

on:
  push:
    branches: [main]
    paths:
      # Trigger when PineScript source files change
      - 'example/pinescript/**/*.pine'
      # Or when transpiler changes
      - 'packages/pine2ts/**'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Need write access to commit generated files

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build transpiler
        run: pnpm --filter @deepentropy/pine2ts build
      
      - name: Generate indicators
        run: |
          # Find all .pine files and transpile them
          for pine_file in example/pinescript/*.pine; do
            if [ -f "$pine_file" ]; then
              # Extract base name and convert to kebab-case
              base_name=$(basename "$pine_file" .pine)
              # Replace spaces first, then convert camelCase to kebab-case
              indicator_name=$(echo "$base_name" | tr ' ' '-' | sed 's/\([a-z0-9]\)\([A-Z]\)/\1-\2/g' | tr '[:upper:]' '[:lower:]')
              output_dir="indicators/$indicator_name"
              output_file="$output_dir/$indicator_name.ts"
              
              echo "Transpiling $pine_file -> $output_file"
              
              # Create output directory if it doesn't exist
              mkdir -p "$output_dir"
              
              # Run the transpiler
              node ./packages/pine2ts/bin/pine2ts.js "$pine_file" "$output_file"
            fi
          done
      
      - name: Compile indicators to JavaScript
        run: |
          # Create dist directory structure
          mkdir -p indicators/dist
          
          # Create a tsconfig for indicator compilation
          cat > indicators/tsconfig.build.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2022",
              "module": "ESNext",
              "moduleResolution": "bundler",
              "declaration": true,
              "declarationMap": true,
              "outDir": "./dist",
              "rootDir": ".",
              "strict": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              "forceConsistentCasingInFileNames": true,
              "resolveJsonModule": true,
              "isolatedModules": true,
              "paths": {
                "@deepentropy/oakscriptjs": ["../packages/oakscriptjs/src/index.ts"]
              }
            },
            "include": ["./**/*.ts"],
            "exclude": ["node_modules", "dist", "tsconfig.build.json"]
          }
          EOF
          
          # Compile TypeScript to JavaScript using esbuild for each indicator
          for indicator_dir in indicators/*/; do
            if [ -d "$indicator_dir" ] && [ "$indicator_dir" != "indicators/dist/" ]; then
              indicator_name=$(basename "$indicator_dir")
              ts_file="$indicator_dir$indicator_name.ts"
              
              if [ -f "$ts_file" ]; then
                echo "Compiling $ts_file to JavaScript..."
                
                mkdir -p "indicators/dist/$indicator_name"
                
                # Use esbuild for fast compilation with bundling
                npx esbuild "$ts_file" \
                  --bundle \
                  --format=esm \
                  --platform=browser \
                  --target=es2022 \
                  --outfile="indicators/dist/$indicator_name/$indicator_name.js" \
                  --external:@deepentropy/oakscriptjs
              fi
            fi
          done
          
          # Also compile the index.ts
          if [ -f "indicators/index.ts" ]; then
            echo "Compiling indicators/index.ts..."
            npx esbuild indicators/index.ts \
              --bundle \
              --format=esm \
              --platform=browser \
              --target=es2022 \
              --outfile="indicators/dist/index.js" \
              --external:@deepentropy/oakscriptjs
          fi
      
      - name: Generate indicator manifest
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const indicatorsDir = 'indicators';
          const distDir = path.join(indicatorsDir, 'dist');
          const manifest = {
            version: '1.0.0',
            generatedAt: new Date().toISOString(),
            baseUrl: 'https://deepentropy.github.io/oakscriptJS/indicators/dist',
            indicators: []
          };
          
          // Read each indicator directory
          const entries = fs.readdirSync(indicatorsDir, { withFileTypes: true });
          for (const entry of entries) {
            if (entry.isDirectory() && entry.name !== 'dist' && entry.name !== 'node_modules') {
              const jsFile = path.join(distDir, entry.name, `${entry.name}.js`);
              if (fs.existsSync(jsFile)) {
                manifest.indicators.push({
                  id: entry.name,
                  name: entry.name.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                  url: `${entry.name}/${entry.name}.js`
                });
              }
            }
          }
          
          fs.writeFileSync(path.join(distDir, 'manifest.json'), JSON.stringify(manifest, null, 2));
          console.log(`Generated manifest with ${manifest.indicators.length} indicators`);
          EOF
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet indicators/ || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit generated indicators
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add indicators/
          git commit -m "chore: auto-generate indicators from PineScript sources

          - Generated TypeScript indicators
          - Compiled JavaScript ES modules to indicators/dist/
          - Updated indicator manifest"
          git push
